<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<#include "/header-smart.html" />
<link rel="stylesheet" href="static/plugins/layui/css/layui.css" media="all">
<link rel="stylesheet" type="text/css" href="static/plugins/handsontable/handsontable.full.min.css?v=21">
<link href="static/plugins/handsontable-select2/select2.css" rel="stylesheet" />
<body >
	<div class="well no-margin">
		<form id="categoryForm">
			<div class="row form-body form-horizontal">
				<div class="col-lg-4 col-md-4 col-sm-4 no-padding">
					<div class="form-group padding-left-20">
						<a id="downloadTpl" href="javascript:void(0);" class="btn btn-default btn-sm">下载模板</a>
					</div>
				</div>
				<div class="col-lg-4 col-md-4 col-sm-4 no-padding">
					<input type="hidden" id="sechemeId" value="${sechemeId}" >
					<div class="form-group margin-bottom-5 margin-right-5">
						<div class="layui-upload-drag" id="test10">
						  <i class="layui-icon"></i>
						  <p>点击上传，或将文件拖拽到此处</p>
						  <p id="tips"></p>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div id="hot"></div>
			</div>
		</form>
	</div>
</body>
<script src="static/js/libs/jquery-3.2.1.min.js"></script>
<script src="static/js/app.config.js"></script>
<script src="static/js/bootstrap/bootstrap.min.js"></script>
<script src="static/js/smartwidgets/jarvis.widget.min.js"></script>
<script src="static/js/app.js?v=1"></script>
<script src="static/plugins/bootstrap-select/js/bootstrap-select.js"></script>
<script src="static/plugins/bootstrap-select/js/i18n/defaults-zh_CN.min.js"></script>
<script src="static/plugins/layer/layer.js"></script>
<script src="static/plugins/layui/layui.js?v=1" ></script>
<script src="static/plugins/handsontable/handsontable.full.js?v=3"></script>
<script src="static/plugins/handsontable/languages/zh-CN.js"></script>
<script src="static/plugins/handsontable-select2/select2.js"></script>
<script src="static/plugins/handsontable-select2/select2-editor.js?v=2"+Math.random()></script>
<script src="static/zmodel/common/js/htValidate.js?v=2222"></script>
<script type="text/javascript">
	var columnConfig=${columnConfig};
	var optionsList=${select2Option};
	var htValidate = new htValidate();
	var hot;
	$(document).ready(function() {
		pageSetUp();
		layui.use('upload', function(){
			var loader=null;
			//上传文件渲染
			layui.upload.render({
			    elem: '#test10',
			    url: 'purchase/uploadImportFile.do',
			    data: {sechemeId: function(){return $("#sechemeId").val()}} ,
			    exts:"xls|xlsx",
			    before: function(obj){
			      loader = layer.load(1, {
					shade: [0.4] //0.1透明度的白色背景
				  });
			      //预读本地文件示例，不支持ie8
			      obj.preview(function(index, file, result){
			        $('#tips').html(file.name); //图片链接（base64）
			      });
			    },
			    done: function(res){
			    	layer.close(loader);
			    	hot.loadData(res.data);
			    },
			    error:function(){
			    	layer.close(loader);
			    }
			});
		})
		
		//下载模板
		$("#downloadTpl").on("click",function(){
			window.location.href = "purchaseSecheme/downloadTpl.do?sechemeId="+ $("#sechemeId").val();
		})
		
		//替换校验类型
		for(var index=0;index< columnConfig.length;index++){
		   var column = columnConfig[index];
		  if(column.validator){
				column.validator = htValidate[column.validator];
		  };
	  	}
		var hotElement = document.querySelector('#hot');
		var hotSettings = {
		  data: [{goodsName:'422694'},{goodsName:'422694'},{goodsName:'422694'},{goodsName:'422694'},{goodsName:'422694'},{goodsName:'422694'}],
		  columns:columnConfig,
		  stretchH: 'all',
		  width : "100%",
		  language : "zh-CN",
		  autoWrapRow: true,
		  height: 450,
		  rowHeaders: true,
		  filters: true,
		  dropdownMenu: ['filter_by_condition','filter_operators','filter_by_condition2','filter_by_value','filter_action_bar'],
		  contextMenu: true,
		  columnSorting:true
		};
		hot = new Handsontable(hotElement, hotSettings);
	});
	
	function customDropdownRenderer(instance, td, row, col, prop, value, cellProperties)
	{
	    var selectedId;
	    var value;
	    for (var index = 0; index < optionsList.length; index++)
	    {
	        if (parseInt(value) === optionsList[index].id)
	        {
	            selectedId = optionsList[index].id;
	            value = optionsList[index].text;            
	        }
	    }
	    $('#selectedId').text(selectedId);
	    $(td).html(value);
	    return td;
	}
	
	function submitData(){
		var data = {};
		data.itemList=hot.getSourceData();
		$.ajax({
		   type: "POST",
		   url: "purchase/saveImportBill.do?sechemeId="+$("#sechemeId").val(),
		   dataType:'json',
		   async:false,
		   data: JSON.stringify(data),
		   contentType:"application/json",
		   success: function(data){
			 	alert("OK")
		   },
	       error:function(){ 
	    	  alert("ERROR")
		   }
 		});
	}
</script>
</html>

